---
sidebar_position: 1
---

# Web 会话回放方案

## 一、调研背景

> -   对于**产品**而言，仅通过点击或 PV 埋点来判断功能的使用情况是不够的，通常需要知道用户的真实使用路径，以判断用户行为是否与预期一致，从而更好分析用户使用情况并做进一步优化和推广
> -   对于**开发**而言，若收到监控报警系统异常通知的时候，系统只能呈现报错代码的 `source map` 信息，无法提供复现路径，对于复现路径深或偶发错误的场景，解决问题费时费力
> -   对于**运营**而言，当用户反馈线上异常的时候，首先需要知道的就是用户通过什么操作触发了这个问题，但常常用户也无法二次复现，而我们也难以通过只言片语的客诉去推导上下文，此时就会产生极大的沟通成本

因此，仅依靠 `Growing IO` 埋点数据、`Sentry` 的代码堆栈上下文、阿里云日志服务是不够的，我们需要一种手段来**获取用户某一时段连续的操作行为**，也就是录制用户操作，包括整个会话中的每一个点击、滑动、输入等行为，并且需要支持回放，从而完整且真实地重现用户操作

## 二、技术思路

先上结论：使用**DOM 快照**思路

| 思路 | 核心 | 兼容性 | 清晰度 | 数据脱敏 | 产物体积 | 用户感知 | 应用 | 结论 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 视频采集 | WebRTC | H5 支持度差 | 有损 | 不支持 | 采集视频体积大 | 采集有感，需用户授权 | 牛客笔试 | ❌ |
| 页面截图 | Canvas | 动画、部分 CSS 和媒体标签不支持 | 有损 | 不支持 | 连续截图的体积大 | 采集无感 | - | ❌ |
| DOM 快照 | DOM | 不支持 Echarts | 有损 | 支持 | JSON 数据体积小 | 采集无感 | 网易云、神策数据 | ✅ |

### 2.1 视频采集

1. 原理：基于操作系统 WebRTC 原生 API，将屏幕操作通过视频的方式录制
2. 相关 API
    1. `getUserMedia`：提示用户给予使用媒体输入的许可从而获取屏幕的流
    2. `getDisplayMedia`：获取展示区域流
    3. `MediaRecorder`：生成对指定的媒体流进行录制的 `MediaRecorder` 对象
    4. `ondataavailable`：当 `MediaRecorder` 将媒体数据传递到应用程序以供使用时将触发该事件
3. 开源参考：`recordRTC` 特点
    1. 用户感知强：需用户控制录屏许可权限，如牛客笔试视频监控
    2. 不支持脱敏：敏感数据无法脱敏，涉及用户隐私和数据安全
    3. 兼容性不佳：本身 PC 存在兼容性，部分 API H5 支持更差，小程序不支持

### 2.2 页面截图

1. 原理：借助 Canvas 截图，将帧连贯成视频后进行播放
2. 开源参考：[html2canvas](https://github.com/niklasvh/html2canvas)
3. 特点
    1. 兼容性不佳：无法绘制动画，部份 css 不支持，媒体标签不支持，存在空白，与实际画面不符
    2. 截图不稳定：动画场景截图卡顿，播放掉帧等
    3. 性能开销大：每秒 24 次截图，性能开销大；一张图 300KB，60 秒产生体积 440M，空间、网络开销大；页面静默依然截图，资源浪费；需要额外进行压缩，画质有损
    4. 脱敏适配差：依托 `html2canvas` 方案进行数据脱敏，将直接删除元素，布局崩塌，无法做到”有占位无内容”，故脱敏页面崩，不脱敏不安全

### 2.3 DOM 快照

1. 原理：保存 DOM 快照，基于 DOM 增量变化（`MutationObserver`）进行记录，最后将节点数据进行回放
2. 开源方案：[rrWeb](https://github.com/rrweb-io/rrweb)
    1. `rrweb-snapshot`：处理 DOM 序列化和重组（包含 snapshot 和 rebuild, snapshot 用于将 DOM 及其状态进行 JSON 序列化并添加唯一标识，rebuild 是将 snapshot 记录的 JSON 进行反序列化重建为 DOM）
    2. `rrweb`：处理采集和回放（包含 record 和 replay，record 用于记录 DOM 中的所有变更，replay 则是将记录的变更按照对应的时间一一重放
    3. `rrweb-player`：视频播放器 UI 控件（包含一套 UI 控件，提供基于 GUI 的暂停、快进、拖拽至任意时间点播放等功能）
3. 特点
    1. 采集效果好：采集无损，有较好的清晰度
    2. 资源体积小：只记录 JSON 数据，对变化只做增量记录，静默不产生额外数据，产物体积小
    3. SDK 拓展强：可自定义插件
    4. 脱敏支持好：能通过类名注入进行数据脱敏

## 三、解决方案

先上结论：**使用 Sentry 实现会话回放**

| 方案 | 部署方式 | 社区建设 | 控制台信息 | 接口日志 | 内存占用 | 背书 | 成本（以年会话 60 万为例） | 结论 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| **Hotjar** | 官方服务器 | 差 | × | × | × | 迪卡侬、微软、Adobe | 3.9 万 | ❌ |
| **观测云** | 公、私有云 | 好 | √ | √ | × | 深信服、安踏、吉利 | 公有云 6 万 | ❌ |
| **Sentry** | 公、私有云 | 好 | √ | √ | √ | 微软、思科、VM Ware、Github | 华为云服务部署价格 | ✅ |
| **FunDebug** | 官方服务器、私有化 | 差 | √ | √ | × | 阳光保险、核桃编程、荔枝 FM | 不支持单项目接入，私有化 30+万 | ❌ |
| **LogRocket** | 官方服务器、私有化 | 差 | √ | √ | × | 思科、宜家 | 公有云 6 万 | ❌ |
| **Dynatrace** | 官方服务器、私有化 | 中 | √ | √ | √ | 戴尔、德国电信、罗马机场 | 公有云 1 万 | ❌ |

### 3.1 [Hotjar](https://www.hotjar.com/)

1. 原理：底层基于类 `rrWeb` 的自研方案，通过记录 Dom 快照实现录屏
2. 优势
    1. 热力分析：提供热力图等，帮助识别用户的关注区域和行为喜好，辅助产品改进
    2. 完整回放：支持用户访问的全链路回放
    3. 背书支持：客户主要为有营收转化需求的电商企业和其它，如 DECATHLON、Microsoft、Adobe
3. 劣势
    1. 数据安全：非开源，不支持私有化部署，依赖官方服务器，仅支持存储 365 天内的数据
    2. 中文支持：平台不支持中文，一定程度上对国人使用不友好
    3. 功能有限：平台提供的功能较少，如接口信息、控制台信息等无法获取，和竞品对比存在明显差距；配置选项少，定制化能力弱，不具备拓展性
    4. 产品付费：以年会话量 60 万计算，接入费用约为 3.9 万元/年
    5. 接入方式：NPM 包、Script 脚本注入
    6. 应用场景：产品发力点聚焦在“用户体验"的数据分析方面，提供热力图、录屏等功能，更适合非研发人员进行用研分析

### 3.2 [观测云](https://www.guance.com/)

1. 原理：是对 `rrweb` 的修改和拓展（官方保守估计改动 30%+），通过记录 DOM 快照实现录屏
2. 核心：用户体验 -> 数据洞察 -> 会话回放
3. 优势
    1. 数据安全：支持公有云和私有云部署，多种数据存储策略，支持自定义存储时长（当前 PV 最长 60 天，回放 14 天）
    2. 视觉交互：官方平台提供的交互、可视化图标等较为美观，条理清晰
    3. 中文支持：平台、文档、客服均为中文，文档内容完善
    4. 背书支持：客户涉及互联网、零售、金融等各行各业，如深信服、英雄互娱、安踏、吉利
    5. 性能监控：在应用性能和数据收集上能力尤为明显
    6. 功能拓展：提供丰富的平台功能，自定义配置程度高
    7. 团队协作：通过配置项给指定 HTTPS 注入 Tarce_id 请求头（类似 request_id），便于问题排查
4. 劣势
    1. 部署成本：私有化部署流程较为繁琐，需要进行 [DataKit 主机安装](https://docs.guance.com/datakit/datakit-install/)
    2. 学习成本；丰富的功能和配置，有一定的学习成本
    3. 图表展示：Echarts 图表回放展示空白，图片展示缺失
    4. 产品付费：公有云方式，以年会话量 60 万为例，接入费用约为 6 万元/年
5. 付费方式
    1. 公有云：功能区分基础计费和梯度计费，不使用的功能不计费，按天扣费
    2. 私有云：支持订阅、按量计费、永久许可 3 种版本
6. 支持场景：支持 Web、微信小程序、UniAPP 小程序、安卓、I0S、Macos 6 种类型的性能监控，会话重放仅支持 Web 类型
7. 接入方式：NPM 包、CDN 同步、CDN 异步
8. 应用场景：产品发力点聚焦用户访问性、用户会话回放、数据统计等功能，兼具埋点功能，实测埋点不好用，适合使用其 Session replay 这一单一功能

### 3.3 [Sentry](https://github.com/getsentry/sentry)

1. 原理：底层基于 `rrWeb`，通过记录 web 应用程序中发生的 DOM 变化进行增量更改
2. 优势
    1. 存储安全：可私有化部署，安全性有保障
    2. 错误监控：捕捉详细的错误和异常，提供详细的错误报告，包括堆栈记录、环境信息、上下文数据
    3. 平台友好：平台支持设置简体中文，对国人使用心智负担相对较低
    4. 功能拓展：功能、配置多，自定义化程度高，支持接入多种通知方式
    5. 代码开源：代码不黑盒，若具备研发能力，可自行修复问题
    6. 背书支持：被大规模使用，如 VMWare、GitHub、Slack、Microsoft、Atlassian、迪斯尼、拳头游戏、思科
3. 劣势
    1. 回放缺陷：不支持 Echarts、SVG、外链图等场景
    2. 配置学习：平台提供丰富的自定义场景，导致使用上有一定学习成本
4. 支持场景：浏览器环境，使用浏览器 SDK 包 `@sentry/browser`，或等价框架包（如`@sentry/react`, `@sentry/vue`）
5. 采集规则
    1. SDK 初始化时，用户会话启动
    2. 在同一域和同一浏览器 Tab 中初始化 SDK，会话就会捕获任何页面加载、刷新或导航
    3. 会话会持续捕获数据，直到 5 分钟后没有任何用户交互或最多 60 分钟过去
    4. 关闭浏览器选项卡将立即结束会话
6. 接入方式：`SDK≥7.27.0`，建议 `≥7.98.0` 或`最新`
7. 性能分析：高版本 Sentry SDK 内置 Replays SDK，整体对包体积无明显影响，但在应用过程中，多了 DOM 变化带来的数据更新上传，故需要根据业务场景调整采样率
8. 应用场景：产品发力点聚焦监控报警方面，兼具研发层的性能分析，会话回放能提供更具体信息，如控制台、网络、存储区等，更适合研发人员进行问题排查

### 3.4 [FunDebug](https://www.fundebug.com/)

具备 Web 会话回放能力，支持闭源私有化部署，国内部分小企业（阳光保险、核桃编程、荔枝 FM、掌门 1 对 1 等）使用的 BUG 监控平台，平台本身也是小企业的产品，背书不足，研发实力较弱，价格较贵，30 万元/年起。会话回放能力不如 Sentry，私有化有部署成本和持续使用费用，不考虑

### 3.5 [LogRocket](https://logrocket.com/)

专注 Web 会话回放能力，支持闭源私有化部署，在 G2 榜单 Best Session Replay Software 上 Top1，国外使用较多（思科、宜家等），SAAS 版本不完全计算为 6 万元/年起。会话回放能力相较 Sentry 类似，私有化有部署成本和持续使用费用，不考虑

### 3.6 [Dynatrace](https://www.dynatrace.com/)

具备 Web 会话回放能力，支持闭源私有化部署，国外使用较多（DELL、德国电信、蒙特利尔银行、罗马机场），SAAS 版本以年会话量 60 万计算则 1 万元/年起。会话回放能力相较 Sentry 类似，私有化有部署成本和持续使用费用，不考虑

## 四、实施计划

### 4.1 Sentry 配置变更

#### 4.1.1 模拟变更发布（若团队已接入 Sentry）

1. 备份当前 Sentry 生成 SentryCopy，部署发布 SentryCopy，生成新的域名，测试 SentryCopy 项目与 Sentry 报警是否一致
2. 在 SentryCopy 代码中，找到 `sentry/sentry.conf.py` 文件，对 `SENTRY_FEATURES.update` 函数进行修改，加入 `"organizations:session-replay"`项
3. 重启 SentryCopy 项目，记录重启过程时长，评估重启导致报警静默的影响范围
4. 重启完成，业务项目代码配置 Session Replays 初始化函数，测试会话回放功能

#### 4.1.2 正式変更发布

1. 模拟 4.1.1 中 2. ，对 Sentry 部署配置进行修改
2. 根据 4.1.1 中 3. 的重启时长，选择低流量时间段，重启 Sentry 服务
3. 业务项目代码配置 Session Replays 初始化函数，对 Sentry 会话回放功能以及错误监控报警功能等进行测试

### 4.2 业务项目对接

#### 4.2.1 测试项目

对小白鼠项目进行持续一周的运行测试

1. 观察 Sentry Replays 板块展示情况
2. 观测 Sentry 机器运行情況，尤其关注「服务的磁盤存储空间」，根据访问量、会话量、空间占用等进行评估，后续可能需要进行“服务扩容”、“过期自动清理”等优化手段

#### 4.2.2 正式项目

逐步接入正式项目，持续观察机器运行情况

## 五、扩展延伸

经调研

-   MiniApp 方面，当前仅微信的 Donut 支持会话回放(截止 2025.2.6 还是 beta 版本)
-   App 方面，国外仅 Dynatrace 平台，但存在技术限制（如不支持 Flutter）；国内仅”基调听云“，但对于 Crush 场景无法捕捉
-   Web 方面，平台底层均是通过“记录 DOM 变化进行增量更新”而实现，存在问题都类似（如 Echarts、Canvas 等支持差）
